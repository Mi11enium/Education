# Центральный процессор ЭВМ
## Структура базового микропроцессора
Основу центрального процессора ПЭВМ составляет
> [!summary] Микропроцессор
> Микропроцессор - обрабатывающее устройство, служащее для арифметических и логических преобразований данных, для организации обращения к ОП и ВнУ и для управления ходом вычислительного процесса.

В настоящее время существует большое число разновидностей микропроцессоров, различающихся назначении, функциональными возможностями, структурой, исполнением. Чаще всего наиболее существенным, **классификационным различием** между ними **является количество разрядов** в обрабатываемой информационной единице:8-битовые, 16-битовые, 32-битовые и др.

Два из микропроцессоров: i8086 и i8088 по назначению и функциональным возможностям одинаковы. Различаются они только разрядностью шины данных системной магистрали: МП i8086 имеет 16-битовую шину данных, а i8088 - 8-битовую. В связи с этим выборка команд и операндов из оперативной памяти производится за разное число машинных циклов. С точки зрения функциональных возможностей существенного значения эти различия не имеют, поэтому и упоминают о них, как правило, вместе: 8086/8088. Этот тип МП является базовым для IBM совместимых машин. Все последующие типы МП основываются на нем и лишь развивают его архитектуру.

МП 8086/8088 имеет базовую систему команд. В следующей модификации МП фирмы Intel - 80186 реализована расширенная система команд. Расширение системы команд продолжается во всех новых моделях, но кроме этого в каждой новой модели вводятся дополнительные архитектурные решения: в 80286 введены встроенный блок управления ОП, работающий в виртуальном режиме (что позволило увеличить предельно допустимый объем виртуальной памяти до 4 Гбайт при 16 Мбайт физической), и блоки, позволяющие реализовать мультизадачность: блок защиты ОП и блок проверки уровня привилегий, присваиваемых каждой задаче. Кроме того, во всех последующих моделях вводятся и совершенствуются средства, позволяющие повысить производительность МП: совершенствуются конвейер команд и встроенный блок управления ОП, вводятся микропрограммное управление операциями, прогнозирование переходов по командам условной передачи управления, скалярная архитектура ЦП (арифметический конвейер) и мультискалярная архитектура (несколько параллельно работающих арифметических конвейеров, одновременно выполняющих несколько машинных операций, благодаря чему появляется возможность за один такт МП выполнять более одной машинной операции). Начиная с 80486, в кристалле МП размещается арифметический сопроцессор для операций с плавающей точкой.

В персональных ЭВМ нашли применение не только микропроцессоры фирмы Intel. Крупнейшими производителями аналогов микропроцессорам Intel (клонов) являются фирмы Cyrix и AMD.

Фирма AMD, завоевавшая около 30% рынка МП в России, выпускает микропроцессоры К-5 и К-6, являющиеся соответственно аналогами Pentium и Pentium Pro.

Структурная схема базовой модели МП фирмы Intel приведена на рис.5.5.
![[processor_scheme.png]]

Условно микропроцессор можно разделить на две части: 
- исполнительный блок (Execution Unit - EU)
- устройство сопряжения с системной магистралью (Bus Interface Unit - ВШ).

В исполнительном блоке находятся: арифметический блок и регистры общего назначения (РОН). Арифметический блок включает арифметико-логическое устройство, вспомогательные регистры для хранения операндов и регистр флагов.

Восемь регистров исполнительного блока МП (АХ, ВХ, СХ, DX, SP, ВР, SI, DI), имеющих длину, равную машинному слову, делятся на две группы. Первую группу составляют регистры общего назначения: АХ, ВХ, СХ и DX, каждый из которых представляет собой регистровую пару, составленную из двух регистров длиной в 0.5 машинного слова: аккумулятор, _или_ регистр АХ состоит из регистров АН и AL. Регистр базы (Base Register) ВХ состоит из регистров ВН и BL. Счетчик (Count Register) СХ включает регистры СН и CL. Регистр данных (Data Register) DX содержит регистры DH и DL. Каждый из коротких регистров может использоваться самостоятельно или в составе регистровой пары. Условные названия (аккумулятор, регистр базы, счетчик, регистр данных) не ограничивают применения этих регистров - эти названия говорят о наиболее частом использовании их или об особенности использования того или иного регистра в той иди иной команде.

Вторую группу составляют адресные регистры SP, BP, SI и DI (в старших моделях количество адресных регистров увеличено). Эти регистры активно используются по функциональному назначению и в других целях их применять не рекомендуется. В качестве адресного регистра часто используется РОН ВХ. Программно допускается использование регистров BP, DI и SI в качестве регистров для хранения операндов, но отдельные байты в этих регистрах недоступны. Основное их назначение - хранить числовые значения, реализуемые при формировании адресов операндов.

Устройство сопряжения с системной магистралью содержит управляющие регистры, конвейер команд, АЛУ команд, устройство управления исполнительным блоком МП и интерфейс памяти (соединяющий внутреннюю магистраль МП с системной магистралью ПЭВМ).

Управляющие регистры BIU: CS (указатель командного сегмента), DS указатель сегмента данных), SS (указатель сегмента стека), ES (указатель дополнительного сегмента) и др. служат для определения физических адресов ОП - операндов и команд. Регистр IP (Instruction Pointer) является указателем адреса команды, которая будет выбираться в конвейер команд в качестве очередной команды (в отечественной литературе такое устройство называется _счетчик команд)._ Конвейер команд МП хранит несколько команд, что позволяет при выполнении линейных программ совместить подготовку очередной команды с выполнением текущей.

К управляющим регистрам МП относится и регистр флагов, каждый разряд которого имеет строго определенное назначение. Обычно разряды регистра флагов устанавливаются аппаратно при выполнении очередной операции в зависимости от получаемого в АЛУ результата. При этом фиксируются такие свойства получаемого результата, как нулевой результат, отрицательное число, переполнение разрядной сетки АЛУ и т.д. Но некоторые разряды регистра флагов могут устанавливаться по специальным командам. Некоторые разряды имеют чисто служебное назначение (например, хранят разряд, (выпавший” из АЛУ во время сдвига) или являются резервными (т.е. не используются).

Все флаги младшего байта регистра устанавливаются арифметическими или логическими операциями МП. Все флаги старших байтов, за исключением флага переполнения, устанавливаются программным путем, для этого в МП имеются команды установки флагов (STC, STD, STI), сброса (CLC CLD, CLI), инвертирования (CMC).
***
### Система команд микропроцессора.
Семейство микропроцессоров фирмы Intel, начиная от 8086 и вплоть до Pentium Pro, имеет базовую систему команд, в состав которой входят следующие группы:

Команды пересылки данных:
- команды пересылки данных внутри МП (MOV, PUSH, POP, XCHNG и т.д.);
- команды ввода-вывода (IN, OUT);
- операции с флагами;
- операции с адресами (LEA, LDS и т.д.)

Арифметические команды:
- основные (сложение, вычитание, умножение, деление);
- дополнительные (INS, DEC и др.)

- логические команды (сдвиг, дизъюнкция, конъюнкция, отрицание равнозначности и др.)
- команды обработки строковых данных (пересылка, сравнение, сканирование, слияние/разделение и др.)
- команды передачи управления (безусловный переход, условный переход, прерывания, переход с возвратом)
- команды управления (“нет операции”, “внешняя синхронизация” и т.д.). Каждая команда имеет большое число модификаций, чаще всего определяемых режимом адресации данных (операндов).

### Представление данных и команд в процессоре. Представление данных и команд в процессорах 80х86.
Машинные команды в процессорах 80х86 занимают от 1 до 6 байтов. Код операции занимает один или два первых байта команды. Команды могут иметь от 0 до 2 операндов. Размер операндов - байт или слово (редко - двойное слово).

### Операнд может быть задан:
- своим значением (непосредственный операнд);
- именем регистра, в котором находится значение операнда;
- указанием адреса ячейки памяти, в которой находится операнд;

Некоторые команды требуют, чтобы их операнд находился в фиксированном месте (например, в регистре AX) и тогда операнд явно не указывается в команде. Результат выполнения команды обычно помещается в ячейку памяти, откуда берется один из операндов.

### В наборе команд 80х86 существет множество форматов представления команд. Рассмотрим для примера некоторые из них:
#### формат “регистр-регистр” (2 байта)

где:
- поле code содержит код операции, которую надо выполнить;
- бит d определяет, в какой из двух регистров записывается результат (1 - в reg1, 0 - в reg2);
- бит w определяет размер операндов (1 -слово, 0 - байт);
- трехбитовые поля reg1 reg2 указывают коды регистров, участвующих в операции:

Имя регистра
Код
Имя регистра
регистра
w=1
w=0
регистра
w=1
w=0
000
AX
AL
100
SP
AH
001
CX
CL
101
BP
CH
010
DX
DL
110
SI
DH
011
BX
BL
111
DI
BH


#### Формат “регистр-память” (2-4 байта):

где:
- первый байт содержит те же поля, что и в предыдущем формате;
- поле mod (2 бита) показывает, сколько байтов в команде занимает операнд (00 - 0 байтов, 01 - 1 байт, 10 - 2 байта);
- поле reg (3 бита) указывает код регистра;

· поле mem (3 бита) указывает способ модификации адреса (a8 - адрес размером в байт, a16 - адрес размером в слово, [r] - содержимое регистра):
mod=00
mod=01
mod=10
mem
mod=00
mod=01
mod=10
000
[BX]+[SI]
[BX]+[SI]+a8
[BX]+[SI]+a16
101
[SI]
[SI]+a8
[SI]+a16
001
[BX]+[DI]
[BX]+[DI]+a8
[BX]+[DI]+a16
101
[DI]
[DI]+a8
[DI]+a16
010
[BP]+[SI]
[BP]+[SI]+a8
[BP]+[SI]+a16
110
a16
[BP]+a8
[BP]+a16
011
[BX]+[DI]
[BX]+[DI]+a8
[BX]+[DI]+a16
111
[BX]
[BX]+a8
[BX]+a16
поле adr содержит адрес памяти (если адрес не задан, он считается нулевым).

#### Формат “регистр-непосредственный операнд” (3-4 байта):

где
- поле code определяет группу операций, а поле code1 уточняет операцию;
- поле s определяет размер операнда в операциях над словами (0 - 2 байта, 1 - 1 байт);
- поле w аналогично этому же полю в первом формате;
- поле reg определяет код регистра;
- поле im задает значение непосредственного операнда.

#### Формат “память-непосредственный операнд” (3-4 байта):

code
s
w
11
code1
mem
im (1-2 байта)
adr (0-2 байта)
где смысл полей тот же, что и для предыдущих форматов.

### Взаимодействие элементов при работе микропроцессора.
Работой МП управляет программа, записанная в ОП ЭВМ. Адрес очередной команды хранится в счетчике команд IP (Instruction Pointer) и в одном из сегментных регистров, чаще всего в CS. Каждый из них в реальном режиме имеет длину 16 бит, тогда как физический адрес ОП должен иметь длину 20 бит. Несогласованность длины машинного слова (16 бит) и длины физического адреса ОП (20 бит) приводит к тому, что в командах невозможно указать физический адрес ОП - его приходится формировать, собирать из разных регистров МП в процессе работы.

В реальном режиме вся ОП делится на сегменты (длина сегмента - 64 Кбайта). Адрес ОП разделяется на две части: номер сегмента в ОП (база сегмента) и номер ячейки внутри данного сегмента (смещение относительно начала сегмента). Базовый адрес сегмента образуется добавлением к номеру сегмента справа четырех нулей. Поскольку последние четыре разряда абсолютного (физического) адреса сегмента всегда нулевые, сегмент может начинаться не с любой ячейки ОП, а только с “параграфа” - начала 16-байтного блока ОП. В структуре микропроцессора имеется несколько регистров сегментов, например в i8086 - четыре: